# ---
# DNS Builder Configuration File
# This file describes the entire environment, from the Docker images to build
# to the final services that will be orchestrated by Docker Compose.
# ---

# Top-level configuration for the entire project.
name: "kaminsky" # A descriptive name for the project. This will be used to create the output directory (e.g., ./output/kaminsky-attack-scenario).
inet: 10.105.0.0/24                 # The Docker network subnet. All services will be part of this network, and IP addresses will be assigned from this range.

# ---
# Image Definitions
#
# This section defines all the Docker images that can be used by the services in the 'builds' section.
# It is a LIST of image definitions. Each item in the list starts with a hyphen (-).
# ---
images:
  - name: "same-bind"
    ref: "standard-bind"
  # --- Image 1: A BIND server, built from source ---
  - # The hyphen marks the beginning of a new image definition in the list.
    name: "standard-bind"   # REQUIRED: A unique name for this image definition. This is the ID you will use in the 'builds' section to refer to this image.
    # ref: null               # 'ref' is null, which means this image MUST be built from scratch. Therefore, 'software', 'version', etc., are required.

    software: "bind"        # REQUIRED (if no ref): The software to install. This tells the image factory which class to use (e.g., BindImage).
    version: "9.18.0"       # REQUIRED (if no ref): The specific version of the software to build.

    dependency:             # REQUIRED (if no ref): A list of system packages needed to COMPILE the software. These are installed first.
      - build-essential
      - pkg-config
      - wget
      - xz-utils
      - libssl-dev
      - libperl-dev
      - libcap-dev
      - libuv1-dev
      - libnghttp2-dev

    util:                   # REQUIRED (if no ref): A list of utility packages for the FINAL running container (e.g., for debugging).
      - vim                 # These are installed near the end of the Dockerfile to take advantage of Docker's layer caching.
      - dnsutils            # Provides tools like 'dig' and 'nslookup'.
      - tcpdump             # For network traffic analysis.
      - tmux
  - name: "bind"
    ref: "bind:9.18.0"
# ---
# Build Definitions (Services)
#
# This section defines the services that will be created in the docker-compose.yml file.
# This is a DICTIONARY, where each key is the name of the service (e.g., 'recursor').
# ---
builds:
  recursor:                                 # The service name. This will be the container's hostname.
    image: "same-bind"                  # REQUIRED: A reference to the 'name' of an image defined in the 'images' list above.
    behavior: example.com forward auth
    volumes:                                # A list of volume mounts.
    #   # The builder will copy the local file './configs/recursor.named.conf'
    #   # into the output directory ('./output/kaminsky-attack-scenario/recursor/contents/')
    #   # and then mount it into the container at the specified path.
      - ./configs/recursor.named.conf:/usr/local/etc/named.conf

    cap_add: null                           # Since this is null (or if the key was omitted entirely), the builder will apply the default capability: ['NET_ADMIN'].
    
    # 'address' is not specified here, so the builder will automatically assign the next available IP address from the 'inet' subnet (e.g., 10.3.0.2).

    # Any other keys, like 'command', are copied directly into the docker-compose.yml for this service.
    # command: ["named", "-g", "-c", "/usr/local/etc/named.conf"] # '-g' runs named in the foreground.

  auth:
    image: "same-bind"                  # We reuse the same BIND image for multiple services, which is efficient.
    ref: "std:auth"
    volumes:
      - ./user/auth_zones.conf:/usr/local/etc/zones.conf
      - ./user/db.example.com:/usr/local/var/named/db.example.com

    # address: 10.3.0.3                       # We are manually assigning a static IP address to this service.