# Dockerfile for {name} (PowerDNS Recursor v{version})
# Auto-generated by DNS Builder

# The base image is now configurable by the Image class
FROM {base_image}

ENV DEBIAN_FRONTEND=noninteractive

# Install chsrc if mirror config uses 'auto'
{chsrc_install_setup}

# Optional mirror setup
{apt_mirror_setup}
{pip_mirror_setup}

# --- STAGE 1: Install Build Dependencies ---
# These packages are required to compile the software. They change infrequently.
{dep_packages}


# --- STAGE 2: Download and Compile Source ---
WORKDIR /usr/src
RUN wget --no-check-certificate https://downloads.powerdns.com/releases/pdns-recursor-{version}.tar.bz2 && tar -xvf pdns-recursor-{version}.tar.bz2

WORKDIR /usr/src/pdns-recursor-{version}
RUN ./configure --prefix=/usr/local --sysconfdir=/usr/local/etc --localstatedir=/usr/local/var && \
    make && \
    make install

# --- STAGE 3: Final Configuration ---
# Set up the environment, user, and permissions for the final image.
RUN groupadd -r pdns && useradd -r -g pdns pdns

# Create necessary directories and the default configuration file
RUN mkdir -p /usr/local/var/run/pdns-recursor \
    && mkdir -p /var/run/pdns-recursor \
    && touch /usr/local/etc/recursor.conf

# Set correct ownership for security
RUN chown -R pdns:pdns /usr/local/etc \
    && chown -R pdns:pdns /usr/local/var/run/pdns-recursor \
    && chown -R pdns:pdns /var/run/pdns-recursor

# --- STAGE 4: Install Runtime Utilities ---
# Install utils for user
{util_packages}

# Expose standard DNS ports
EXPOSE 53/tcp
EXPOSE 53/udp

# Change the Work Dir
WORKDIR /usr/local/etc

# Set default user
USER pdns

# Define default command
# CMD ["/usr/local/sbin/pdns_recursor", "--config-dir=/usr/local/etc"]