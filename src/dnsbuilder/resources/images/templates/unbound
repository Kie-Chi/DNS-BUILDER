# Dockerfile for {name} (Unbound v{version})
# Auto-generated by DNS Builder

# The base image is now configurable by the Image class
FROM {base_image}

ENV DEBIAN_FRONTEND=noninteractive

# Optional mirror setup
{apt_mirror_setup}
{pip_mirror_setup}

# --- STAGE 1: Install Build Dependencies ---
# These packages are required to compile the software. They change infrequently.
RUN apt-get update && apt-get install -y --no-install-recommends {dep_packages}

# --- STAGE 2: Download and Compile Source ---
WORKDIR /usr/src
RUN wget --no-check-certificate https://nlnetlabs.nl/downloads/unbound/unbound-{version}.tar.gz && tar -xzvf unbound-{version}.tar.gz

WORKDIR /usr/src/unbound-{version}
RUN ./configure --prefix=/usr/local --sysconfdir=/usr/local/etc --with-pthreads --with-libssl && \
    make && \
    make install

# --- STAGE 3: Final Configuration ---
# Set up the environment, user, and permissions for the final image.

RUN groupadd -r unbound && useradd -r -g unbound unbound
RUN mkdir -p /usr/local/var/unbound && \
    mkdir -p /var/cache/unbound && \
    mkdir -p /usr/local/var/run/unbound && \
    chown -R unbound:unbound /usr/local/var/run/unbound && \
    chown -R unbound:unbound /var/cache/unbound && \
    chown -R unbound:unbound /usr/local/var/unbound && \
    chown -R unbound:unbound /usr/local/etc

RUN touch /usr/local/etc/unbound.conf && \
    chown unbound:unbound /usr/local/etc/unbound.conf

# --- STAGE 4: Install Runtime Utilities ---
# Install utils for user
RUN apt-get update && apt-get install -y --no-install-recommends {util_packages} && \
    rm -rf /var/lib/apt/lists/*

# Expose standard DNS ports
EXPOSE 53/tcp
EXPOSE 53/udp
EXPOSE 8953/tcp
EXPOSE 8953/udp

# Set default user (can't be used right now)
# USER unbound
WORKDIR /usr/local/etc

# Define default command
# CMD ["unbound", "-d"]