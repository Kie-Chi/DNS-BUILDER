# Dockerfile for {name} (BIND v{version})
# Auto-generated by DNS Builder

# The base image is now configurable by the Image class
FROM {base_image}

ENV DEBIAN_FRONTEND=noninteractive

# --- STAGE 1: Install Build Dependencies ---
# These packages are required to compile the software. They change infrequently.
RUN apt-get update && apt-get install -y --no-install-recommends {dep_packages}

# if there is any Python-deps
{py3_packages}

# --- STAGE 2: Download and Compile Source ---
WORKDIR /usr/src
RUN (wget --no-check-certificate https://downloads.isc.org/isc/bind9/{version}/bind-{version}.tar.xz && tar -xvf bind-{version}.tar.xz) || (wget --no-check-certificate https://downloads.isc.org/isc/bind9/{version}/bind-{version}.tar.gz && tar -xzvf bind-{version}.tar.gz)

WORKDIR /usr/src/bind-{version}
RUN ./configure --prefix=/usr/local --sysconfdir=/usr/local/etc --localstatedir=/usr/local/var && \
    make && \
    make install

# --- STAGE 3: Final Configuration ---
# Set up the environment, user, and permissions for the final image.
ENV LD_LIBRARY_PATH=/usr/local/lib/:$LD_LIBRARY_PATH

RUN groupadd -r named && useradd -r -g named named
RUN mkdir -p /usr/local/var/named && \
    mkdir -p /var/cache/named && \
    mkdir -p /usr/local/var/run/named && \
    touch /usr/local/etc/named.conf && \
    /usr/local/sbin/rndc-confgen -a

RUN chown named:named /usr/local/etc/named.conf && \
    chown -R named:named /usr/local/var/run/named && \
    chown -R named:named /var/cache/named && \
    chown -R named:named /usr/local/var/named && \
    chown -R named:named /usr/local/etc

# --- STAGE 4: Install Runtime Utilities ---
# Install utils for user
RUN apt-get update && apt-get install -y --no-install-recommends {util_packages} && \
    rm -rf /var/lib/apt/lists/*

# Expose standard DNS ports
EXPOSE 53/tcp
EXPOSE 53/udp
# Expose rndc port
EXPOSE 953/tcp
EXPOSE 953/udp

# Change the Work Dir
WORKDIR /usr/local/var/named

# Set default user
USER named

# Define default command
# CMD ["/usr/local/sbin/named", "-g", "-c", "/usr/local/etc/named.conf"]